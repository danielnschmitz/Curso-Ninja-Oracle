CREATE OR REPLACE PACKAGE PACK_NOTAFISCAL IS

  -- AUTHOR  : DANIEL.NATAN
  -- CREATED : 16/10/2021 13:15:39
  -- PURPOSE : PACOTE PARA CENTRALIZAR OS PROCEDIMENTOS REFERENTES A NOTA FISCAL
  
  PROCEDURE INSERE_NOTA (I_NR_NOTA     IN NOTAFISCAL.NR_NOTA%TYPE,
                         I_VL_NOTA     IN NOTAFISCAL.VL_NOTA%TYPE,
                         I_DS_VENDEDOR IN NOTAFISCAL.DS_VENDEDOR%TYPE,
                         I_DS_CLIENTE  IN NOTAFISCAL.DS_CLIENTE%TYPE,
                         I_DT_COMPRA   IN NOTAFISCAL.DT_COMPRA%TYPE,
                         O_MENSAGEM    OUT VARCHAR2);

END PACK_NOTAFISCAL;
/
CREATE OR REPLACE PACKAGE BODY PACK_NOTAFISCAL IS
  PROCEDURE INSERE_NOTA (I_NR_NOTA     IN NOTAFISCAL.NR_NOTA%TYPE,
                         I_VL_NOTA     IN NOTAFISCAL.VL_NOTA%TYPE,
                         I_DS_VENDEDOR IN NOTAFISCAL.DS_VENDEDOR%TYPE,
                         I_DS_CLIENTE  IN NOTAFISCAL.DS_CLIENTE%TYPE,
                         I_DT_COMPRA   IN NOTAFISCAL.DT_COMPRA%TYPE,
                         O_MENSAGEM    OUT VARCHAR2) IS
    V_NR_NOTA NOTAFISCAL.NR_NOTA%TYPE;
  BEGIN
    
    SELECT MAX(NOTAFISCAL.NR_NOTA)
      INTO V_NR_NOTA
      FROM NOTAFISCAL;
    
    /*
    V_NR_NOTA = NULL
    V_NR_NOTA = 1..N
    */
    
    V_NR_NOTA := NVL(V_NR_NOTA,0) + 1;
    
    BEGIN
      INSERT INTO NOTAFISCAL
       (NR_NOTA,
        VL_NOTA,
        DS_VENDEDOR,
        DS_CLIENTE,
        DT_COMPRA)
      VALUES
       (NVL(I_NR_NOTA,V_NR_NOTA),
        I_VL_NOTA,
        I_DS_VENDEDOR,
        I_DS_CLIENTE,
        I_DT_COMPRA);
    EXCEPTION
      WHEN DUP_VAL_ON_INDEX THEN
        BEGIN
          UPDATE NOTAFISCAL
             SET VL_NOTA = I_VL_NOTA,
                 DS_VENDEDOR = I_DS_VENDEDOR,
                 DS_CLIENTE = I_DS_CLIENTE,
                 DT_COMPRA = I_DT_COMPRA
           WHERE NR_NOTA = I_NR_NOTA;
        EXCEPTION
          WHEN OTHERS THEN
            O_MENSAGEM := 'Erro ao atualizar nota. Erro: '||SQLERRM;
        END;
    END;
    
  EXCEPTION
    WHEN OTHERS THEN
      O_MENSAGEM := 'Erro ao inserir nota fiscal. Erro: '||SQLERRM;
  END;
 
END PACK_NOTAFISCAL;
/
